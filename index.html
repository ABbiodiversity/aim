<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Alex MacPhail">
<meta name="dcterms.date" content="2024-10-02">

<title>Adaptive Image Monitoring (AIM) Program</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="aim_files/libs/clipboard/clipboard.min.js"></script>
<script src="aim_files/libs/quarto-html/quarto.js"></script>
<script src="aim_files/libs/quarto-html/popper.min.js"></script>
<script src="aim_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="aim_files/libs/quarto-html/anchor.min.js"></script>
<link href="aim_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="aim_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="aim_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="aim_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="aim_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="aim_files/libs/kePrint-0.0.1/kePrint.js"></script>
<link href="aim_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#concepts" id="toc-concepts" class="nav-link active" data-scroll-target="#concepts">Concepts</a>
  <ul>
  <li><a href="#unconventional-camera-placements" id="toc-unconventional-camera-placements" class="nav-link" data-scroll-target="#unconventional-camera-placements">Unconventional camera placements</a></li>
  <li><a href="#distance-based-detection" id="toc-distance-based-detection" class="nav-link" data-scroll-target="#distance-based-detection">Distance-based detection</a></li>
  <li><a href="#point-based-image-tagging" id="toc-point-based-image-tagging" class="nav-link" data-scroll-target="#point-based-image-tagging">Point-based image tagging</a></li>
  <li><a href="#event-tagging" id="toc-event-tagging" class="nav-link" data-scroll-target="#event-tagging">Event tagging</a></li>
  <li><a href="#artificial-intelligence" id="toc-artificial-intelligence" class="nav-link" data-scroll-target="#artificial-intelligence">Artificial Intelligence</a></li>
  <li><a href="#proposed-wildtrax-enhancements" id="toc-proposed-wildtrax-enhancements" class="nav-link" data-scroll-target="#proposed-wildtrax-enhancements">Proposed WildTrax Enhancements</a></li>
  </ul></li>
  <li><a href="#business-cases" id="toc-business-cases" class="nav-link" data-scroll-target="#business-cases">Business Cases</a>
  <ul>
  <li><a href="#nest-monitoring" id="toc-nest-monitoring" class="nav-link" data-scroll-target="#nest-monitoring">Nest monitoring</a>
  <ul class="collapse">
  <li><a href="#pileated-woodpecker" id="toc-pileated-woodpecker" class="nav-link" data-scroll-target="#pileated-woodpecker">Pileated Woodpecker</a></li>
  <li><a href="#owls" id="toc-owls" class="nav-link" data-scroll-target="#owls">Owls</a></li>
  </ul></li>
  <li><a href="#colony-and-group-monitoring" id="toc-colony-and-group-monitoring" class="nav-link" data-scroll-target="#colony-and-group-monitoring">Colony and group monitoring</a>
  <ul class="collapse">
  <li><a href="#seabirds" id="toc-seabirds" class="nav-link" data-scroll-target="#seabirds">Seabirds</a></li>
  <li><a href="#feral-horses" id="toc-feral-horses" class="nav-link" data-scroll-target="#feral-horses">Feral Horses</a></li>
  <li><a href="#bats" id="toc-bats" class="nav-link" data-scroll-target="#bats">Bats</a></li>
  <li><a href="#swallows" id="toc-swallows" class="nav-link" data-scroll-target="#swallows">Swallows</a></li>
  <li><a href="#ducks" id="toc-ducks" class="nav-link" data-scroll-target="#ducks">Ducks</a></li>
  </ul></li>
  <li><a href="#groud-level-monitoring" id="toc-groud-level-monitoring" class="nav-link" data-scroll-target="#groud-level-monitoring">Groud-level monitoring</a>
  <ul class="collapse">
  <li><a href="#small-mammals" id="toc-small-mammals" class="nav-link" data-scroll-target="#small-mammals">Small mammals</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Adaptive Image Monitoring (AIM) Program</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Alex MacPhail </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 2, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>The Adaptive Image Monitoring (AIM) program is a collaborative initiative focused on enhancing biodiversity data collection through the strategic placement of remote camera traps in diverse scenarios. By employing science-based decision-making and standardized protocols, AIM optimizes remote camera placement to increase habitat and species coverage, thereby providing deeper and more accurate insights into species behaviour, population dynamics, and ecology. Integrated with WildTraxâ€™s remote camera sensor, AIM efficiently channels this data into streamlined workflows, facilitating consistent and reliable long-term species monitoring.</p>
<section id="concepts" class="level2">
<h2 class="anchored" data-anchor-id="concepts">Concepts</h2>
<section id="unconventional-camera-placements" class="level3">
<h3 class="anchored" data-anchor-id="unconventional-camera-placements">Unconventional camera placements</h3>
<p>Remote camera traps are a widely used tool for monitoring animals with deployment strategies designed to optimize detection rates principally for medium to large mammals. These cameras are typically positioned at key locations, such as along wildlife trails, near water sources, at feeding stations, or in random designs to capture the activity of target species. By strategically placing remote camera traps, researchers can calculate detection rates across a range of taxa, maximizing the efficiency and output of these devices. Beyond mammals, remote camera traps can also be effective in capturing other fauna, including birds, reptiles, or small mammals, depending on the setup and environment. The integration of remote camera trap data with other environmental sensors (e.g., acoustic sensors) also allows for a more comprehensive view of ecosystem dynamics, providing valuable insights into species behavior, population trends, and habitat use.</p>
<p>Incorporating remote camera trap data from various uses and sources into platforms like WildTrax presents significant potential. By integrating remote camera trap data alongside acoustic and other environmental sensor data, WildTrax can serve as a centralized repository for diverse types of wildlife monitoring data. This harmonization allows researchers to analyze cross-sensor data in a unified format, leading to richer ecological insights and improving the potential for artificial intelligence-driven analytics. With the right data management strategies, WildTrax can support the scaling of remote camera trap studies, improving accessibility for various stakeholders and enhancing species monitoring efforts at larger ecological scales.</p>
</section>
<section id="distance-based-detection" class="level3">
<h3 class="anchored" data-anchor-id="distance-based-detection">Distance-based detection</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="distance.png" class="wrapping img-fluid figure-img"></p>
<figcaption>Known distances to features</figcaption>
</figure>
</div>
<p>Estimating how far an animal is from a camera is important for understanding animal density and distribution. Distance-based detection allows researchers to calculate the effective detection range of the camera, which can then be used to estimate animal densities within the surveyed area. Factors such as vegetation, terrain, and species-specific behaviour can influence detection distances, making it important to calibrate camera trap systems for precise measurements. Distance-based data not only improves species counts but can also enable spatial modeling of animal movements and habitat preferences. By combining this information with camera trap data in WildTrax, researchers can map species distributions, analyze animal densities over large areas, and refine conservation strategies based on real-time, location-specific data. This approach increases the accuracy of density estimates and enhances our understanding of how species use their environment across different landscapes and ecosystems.</p>
</section>
<section id="point-based-image-tagging" class="level3">
<h3 class="anchored" data-anchor-id="point-based-image-tagging">Point-based image tagging</h3>
<p>Point-based image tagging provides a more efficient way to label small or distant objects within images, compared to bounding boxes. In situations where animals or objects occupy only a small portion of the image, tagging the exact location with a point can increase precision and reduce ambiguity. This method is particularly useful for identifying smaller species, distinguishing between multiple animals in the same frame, or tagging specific features, such as nests or food items, within cluttered environments. Implementing point-based tagging in WildTrax allows users to label data more accurately, improving the quality of machine learning training sets and enabling artificial intelligence models to detect and classify objects with greater accuracy. This technique can streamline data processing, reducing manual tagging efforts while maintaining high-quality datasets for ecological studies.</p>
</section>
<section id="event-tagging" class="level3">
<h3 class="anchored" data-anchor-id="event-tagging">Event tagging</h3>
<p>Reporting on behaviours occurring in an image is vital for providing context to the animalâ€™s life history. Event tagging helps researchers and automated systems capture these behaviors, such as foraging, resting, or interacting with other animals. Tagging these events can offer insights into speciesâ€™ activity patterns, behavioral ecology, and interactions with their environment. For example, identifying the presence of offspring or predation behavior can add depth to species monitoring efforts, enabling more informed conservation decisions. By incorporating event tags into platforms like WildTrax, researchers can systematically categorize behaviors, improving data richness and making it easier to analyze trends over time. This allows for more granular data interpretation and provides a clearer picture of speciesâ€™ activity patterns across various ecosystems.</p>
</section>
<section id="artificial-intelligence" class="level3">
<h3 class="anchored" data-anchor-id="artificial-intelligence">Artificial Intelligence</h3>
<p>Artificial intelligence (AI) can significantly enhance the speed and accuracy of data processing. By automating tasks such as species identification, behavior tagging, and event detection, AI reduces the manual effort required for image and video analysis. Machine learning models can be trained to recognize species-specific traits and behaviors, helping researchers analyze large datasets more efficiently. This also enables the discovery of patterns that might be difficult for humans to detect, leading to more insightful ecological analyses. Enhancing the current AI-driven algorithms in WildTrax, i.e.&nbsp;Megadetector can accelerate data processing workflows, improves accuracy, and opens new avenues for large-scale wildlife monitoring, making it easier to manage and interpret data from various sensors.</p>
</section>
<section id="proposed-wildtrax-enhancements" class="level3">
<h3 class="anchored" data-anchor-id="proposed-wildtrax-enhancements">Proposed WildTrax Enhancements</h3>
<p>With this we aim to achieve the goals of having adaptive camera usage implemented by several key enhancements to WildTrax:</p>
<ul>
<li>Target additions (e.g., nest cavities): New features allow users to tag specific targets such as nest cavities, adding detail to species observations.</li>
<li>Target metadata (e.g., cavity size, cavity depth): These fields capture critical attributes of target structures, providing deeper insights into habitat usage.</li>
<li>Species behaviours (e.g., entering/exiting cavity, feeding young): The ability to tag specific behaviors adds context to speciesâ€™ life history and reproductive strategies.</li>
<li>Sensor to target metadata (e.g., distance, angle): This enables more precise data collection by recording how sensor placement relates to the target, improving the accuracy of behavioural data.</li>
<li>Field of view metadata (e.g., zoomed in): Adding metadata on camera zoom levels allows researchers to standardize observations across different levels of magnification.</li>
<li>Visit metadata additions (e.g., survey polygons): Survey polygons offer spatial context, helping to map the exact area covered during a visit.</li>
<li>Explore efficiencies in the usage of aritifical intelligence for event, point and group-based tagging</li>
<li>Analytics: Expanded analytics capabilities allow users to generate detailed reports on species detections, behavior, and environmental conditions across time and space.</li>
</ul>
</section>
</section>
<section id="business-cases" class="level2">
<h2 class="anchored" data-anchor-id="business-cases">Business Cases</h2>
<section id="nest-monitoring" class="level3">
<h3 class="anchored" data-anchor-id="nest-monitoring">Nest monitoring</h3>
<p>The <a href="https://www.canada.ca/en/environment-climate-change/services/avoiding-harm-migratory-birds/fact-sheet-nest-protection-under-mbr-2022.html">Migratory Birds Regulations, 2022</a> (MBR 2022) represent a significant shift in the protection of migratory bird nests across Canada. Previously, the Migratory Birds Regulations (MBR) provided year-round protection for the nests of all 395 migratory bird species, regardless of whether they were active. However, under MBR 2022, protection has been narrowed to nests that contain a live bird or viable egg, aligning conservation efforts with the active use of the nest. This change emphasizes that the conservation value of most nests is highest during periods of occupancy, offering a more targeted approach. For 18 species (see @ref(fig:nests)) listed on Schedule 1, nests receive year-round protection until they are deemed abandoned. This regulatory adjustment enhances both conservation outcomes and the ability for stakeholders to predict and manage their compliance while working on landscapes that may impact bird nests.</p>
<p>MBR 2022 requires stakeholders to monitor nests for up to three years in some cases, placing new legal obligations on regulators, developers, and land managers. This creates a substantial demand for resources to collect, interpret, and report on nest monitoring data in a standardized, compliant manner. WildTrax is uniquely positioned to meet this need, providing tools to streamline the collection, analysis, and reporting of nest data. As a result, we can anticipate a significant increase in both current users and new users turning to WildTrax to ensure regulatory compliance and to create efficient pipelines for species protection and remediation.</p>
<div class="cell" data-show="false">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Migratory Bird Nest Protection Schedule</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Species of migratory bird</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Waiting period (months)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Pigeon Guillemot</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="even">
<td style="text-align: left;">Rhinoceros Auklet</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Atlantic Puffin</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="even">
<td style="text-align: left;">Tufted Puffin</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Horned Puffin</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="even">
<td style="text-align: left;">Manx Shearwater</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Northern Gannet</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="even">
<td style="text-align: left;">Fork-tailed Storm Petrel</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Leachâ€™s Storm Petrel</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="even">
<td style="text-align: left;">Cassin`s Auklet</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Ancient Murrelet</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="even">
<td style="text-align: left;">Great Egret</td>
<td style="text-align: right;">24</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Great Blue Heron</td>
<td style="text-align: right;">24</td>
</tr>
<tr class="even">
<td style="text-align: left;">Cattle Egret</td>
<td style="text-align: right;">24</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Green Heron</td>
<td style="text-align: right;">24</td>
</tr>
<tr class="even">
<td style="text-align: left;">Snowy Egret</td>
<td style="text-align: right;">24</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Black-crowned Night Heron</td>
<td style="text-align: right;">24</td>
</tr>
<tr class="even">
<td style="text-align: left;">Pileated Woodpecker</td>
<td style="text-align: right;">36</td>
</tr>
</tbody>
</table>


</div>
</div>
<section id="pileated-woodpecker" class="level4">
<h4 class="anchored" data-anchor-id="pileated-woodpecker">Pileated Woodpecker</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="piwo.jpg" class="wrapping img-fluid figure-img"></p>
<figcaption>Pileated Woodpecker</figcaption>
</figure>
</div>
<p>The MBR 2022 protects Pileated Woodpecker nests year-round, requiring a 36-month wait before removing unoccupied cavities. Recent projects (<a href="(https://ee-bgcasey-piwomodels.projects.earthengine.app/view/pileatedwoodpecker)">Casey et al.&nbsp;2024</a> have shown that using predictive mapping and remote sensing tools to help locate nests and optimize monitoring, with regular updates based on new data, will help to streamline the workflow behind.</p>
</section>
<section id="owls" class="level4">
<h4 class="anchored" data-anchor-id="owls">Owls</h4>
</section>
</section>
<section id="colony-and-group-monitoring" class="level3">
<h3 class="anchored" data-anchor-id="colony-and-group-monitoring">Colony and group monitoring</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="murre.jpg" class="wrapping img-fluid figure-img"></p>
<figcaption>Murre</figcaption>
</figure>
</div>
<p>The study of groups and colonies of species has historically presented significant challenges for researchers aiming to elucidate biological metrics. The adoption of remote camera traps has transformed colony monitoring, yielding more accessible and reliable data compared to conventional methodologies such as aerial surveys and boat-based counts. The AIM program recognizes the potential synergies afforded by remote cameras in facilitating the comprehensive data lifecycle, from initial collection through to analysis. In light of recent advancements in individual identification techniques, the AIM program aims to integrate acoustic recording units (ARUs) and camera data collection, thereby enhancing insights into these speciesâ€™ ecology and behaviour.</p>
<section id="seabirds" class="level4">
<h4 class="anchored" data-anchor-id="seabirds">Seabirds</h4>
<p>Seabird colony monitoring presents significant challenges due to the remoteness of many colonies and the logistical difficulties of conducting more than one survey per season. Traditional monitoring methods often provide only a snapshot of colony activity, limiting our understanding of critical factors such as arrival times, breeding success, and seasonal behaviors. Deploying cameras at seabird colonies offers a transformative solution, allowing for continuous time-lapse photography and other forms of image capture, which dramatically increase the amount of data available. This approach provides a more comprehensive view of colony dynamics, including daily and seasonal patterns that would otherwise go unnoticed. Enhancements to WildTrax would create a seamless platform for users to efficiently manage seabird colony monitoring via camera traps. By integrating camera data with analytical tools and automating workflows, WildTrax can streamline the process of collecting, processing, and interpreting the massive volumes of image data generated from remote sites. This capability would not only improve the efficiency of monitoring efforts but also allow for more frequent and detailed observations, contributing to a deeper understanding of seabird behavior and population trends.</p>
<p>There is a growing need for data management solutions to support these efforts, particularly from Environment and Climate Change Canada (ECCC). ECCC is tasked with overseeing the protection of migratory species, including seabirds, and faces increasing pressure to improve monitoring capabilities under evolving regulations. The ability to collect, store, and analyze large datasets from remote colonies is essential for compliance, conservation planning, and reporting. WildTrax can fulfill this need by offering an integrated system that helps stakeholders manage seabird monitoring data in a standardized, accessible way, ensuring that regulatory and conservation objectives are met efficiently and effectively.</p>
</section>
<section id="feral-horses" class="level4">
<h4 class="anchored" data-anchor-id="feral-horses">Feral Horses</h4>
<p>Feral horse abundance / density</p>
</section>
<section id="bats" class="level4">
<h4 class="anchored" data-anchor-id="bats">Bats</h4>
<p>Can we take pictures of bats exiting colonies?</p>
</section>
<section id="swallows" class="level4">
<h4 class="anchored" data-anchor-id="swallows">Swallows</h4>
<p>Can we take pictures of swallows at roost / colonies? Under bridges? Wide-angle view to count flocks?</p>
</section>
<section id="ducks" class="level4">
<h4 class="anchored" data-anchor-id="ducks">Ducks</h4>
<p>Can we compare camera vs ARUs for duck counts when the camera is beside a lake?</p>
</section>
</section>
<section id="groud-level-monitoring" class="level3">
<h3 class="anchored" data-anchor-id="groud-level-monitoring">Groud-level monitoring</h3>
<section id="small-mammals" class="level4">
<h4 class="anchored" data-anchor-id="small-mammals">Small mammals</h4>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>